# ========================================
# DevContainerãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šç‰ˆï¼ˆReleaseä½œæˆä¿®æ­£ç‰ˆï¼‰
# ========================================
name: Build and Release (Manual)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå· (ä¾‹: v1.0.3 ã¾ãŸã¯ 1.0.3)'
        required: true
        type: string
      create_release:
        description: 'GitHub Releaseã‚’ä½œæˆã™ã‚‹'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: write
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate and normalize version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # v ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼ˆãªã‘ã‚Œã°ï¼‰
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v${VERSION}"
          fi
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ãŒä¸æ­£ã§ã™"
            echo "   æ­£ã—ã„å½¢å¼: v1.0.3 ã¾ãŸã¯ 1.0.3"
            echo "   å…¥åŠ›ã•ã‚ŒãŸå€¤: ${{ github.event.inputs.version }}"
            exit 1
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_short=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"

      - name: Check if tag already exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if git ls-remote --tags origin | grep -q "refs/tags/${VERSION}$"; then
            echo "âš ï¸  è­¦å‘Š: ã‚¿ã‚° ${VERSION} ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
            echo "   æ—¢å­˜ã®ã‚¿ã‚°ã‚’ä¸Šæ›¸ãã—ã¾ã™"
          else
            echo "âœ… ã‚¿ã‚° ${VERSION} ã¯æ–°è¦ä½œæˆã•ã‚Œã¾ã™"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version_short }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.version.outputs.version }}
            type=sha,prefix=sha-

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Create and push version tag
        if: success()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ—¢å­˜ã®ã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
          git tag -d "${VERSION}" 2>/dev/null || true
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆ
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          
          # ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ—¢å­˜ã®ã‚¿ã‚°ãŒã‚ã‚Œã°ä¸Šæ›¸ãï¼‰
          git push origin "${VERSION}" --force
          
          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚° ${VERSION} ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: Update latest tag
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ—¢å­˜ã®latestã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
          git tag -d latest 2>/dev/null || true
          
          # ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆã«latestã‚¿ã‚°ã‚’è¨­å®š
          git tag -a latest -m "Latest release: ${{ steps.version.outputs.version }}"
          
          # ãƒªãƒ¢ãƒ¼ãƒˆã®latestã‚¿ã‚°ã‚’å¼·åˆ¶æ›´æ–°
          git push origin latest --force
          
          echo "âœ… latestã‚¿ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: Generate release notes
        if: success() && github.event.inputs.create_release == 'true'
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_SHORT="${{ steps.version.outputs.version_short }}"
          
          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          cat > release_notes.md << 'EOF'
          ## DevContainer Base Image ${{ steps.version.outputs.version }}
          
          ### ğŸ³ Docker Image
          
          ```bash
          # å®Œå…¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
          docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version_short }}
          
          # æœ€æ–°ç‰ˆ
          docker pull ghcr.io/${{ github.repository }}:latest
          ```
          
          ### ğŸ“¦ ä½¿ç”¨æ–¹æ³•
          
          **devcontainer.json**
          ```json
          {
            "image": "ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version_short }}",
            "remoteUser": "vscode"
          }
          ```
          
          ### ğŸ“‹ å¤‰æ›´å†…å®¹
          
          è©³ç´°ã¯ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          
          ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
          
          - [Docker Image](https://github.com/${{ github.repository }}/pkgs/container/devcontainer-base)
          - [ã‚³ãƒŸãƒƒãƒˆå±¥æ­´](https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.version }})
          EOF
          
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

      - name: Create GitHub Release
        if: success() && github.event.inputs.create_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          gh release delete "${VERSION}" --yes 2>/dev/null || true
          
          # æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
          gh release create "${VERSION}" \
            --title "Release ${VERSION}" \
            --notes-file release_notes.md \
            --target "${{ github.sha }}"
          
          echo "âœ… GitHub Release ${VERSION} ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: Summary
        if: success()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "========================================="
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹å®Œäº†!"
          echo "========================================="
          echo ""
          echo "ğŸ“Œ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"
          echo ""
          echo "ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸:"
          echo "   - ghcr.io/${{ github.repository }}:latest"
          echo "   - ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version_short }}"
          echo ""
          echo "ğŸ·ï¸  Gitã‚¿ã‚°:"
          echo "   - ${VERSION}"
          echo "   - latest"
          echo ""
          if [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "ğŸ“¦ GitHub Release:"
            echo "   https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
          fi
          echo ""
